<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> | DailyEdge Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/css/style.css">
    
    <style>
        .admin-nav {
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .admin-nav .navbar-brand {
            font-weight: 600;
            color: var(--color-danger);
        }
    </style>
</head>
<body class="animation-fadeIn">
    <!-- Admin Navigation -->
    <nav class="admin-nav">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="navbar-brand">üîê DailyEdge Admin Panel</div>
                <div class="d-flex gap-3 align-items-center">
                    <span class="text-muted">Welcome, <%= currentAdmin.username %></span>
                    <a href="/admin/dashboard" class="btn btn-sm btn-outline-primary">Dashboard</a>
                    <a href="/admin/users" class="btn btn-sm btn-primary">Users</a>
                    <a href="/admin/challenges" class="btn btn-sm btn-outline-primary">Challenges</a>
                    <a href="/admin/logout" class="btn btn-sm btn-danger">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>User Profile: <%= user.username %></h1>
            <a href="/admin/users" class="btn btn-secondary">‚Üê Back to Users</a>
        </div>

        <!-- User Info Card -->
        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">User Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Username:</strong> <%= user.username %></p>
                                <p><strong>Email:</strong> <%= user.email %></p>
                                <p><strong>User ID:</strong> <%= user.id %></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>XP:</strong> <%= user.xp %></p>
                                <p><strong>Joined:</strong> <%= new Date(user.created_at).toLocaleDateString() %></p>
                                <p><strong>Status:</strong> 
                                    <% if (user.is_suspended) { %>
                                        <span class="badge bg-danger">Suspended</span>
                                    <% } else { %>
                                        <span class="badge bg-success">Active</span>
                                    <% } %>
                                </p>
                            </div>
                        </div>
                        <% if (user.is_suspended && user.suspended_reason) { %>
                            <div class="alert alert-warning mt-3">
                                <strong>Suspension Reason:</strong> <%= user.suspended_reason %>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Quick Stats</h5>
                        <p><strong>Total Habits:</strong> <%= habits.length %></p>
                        <p><strong>Active Challenges:</strong> <%= challenges.filter(c => c.status !== 'completed').length %></p>
                        <p><strong>Badges Earned:</strong> <%= badges.length %></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Actions -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Admin Actions</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Update XP</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="xpInput" value="<%= user.xp %>">
                            <button class="btn btn-primary" onclick="updateXP()">Update</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Award Badge</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="badgeInput" placeholder="Badge Name">
                            <button class="btn btn-success" onclick="awardBadge()">Award</button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Account Actions</label>
                        <div class="d-grid gap-2">
                            <% if (user.is_suspended) { %>
                                <button class="btn btn-success" onclick="unsuspendUser()">Unsuspend User</button>
                            <% } else { %>
                                <button class="btn btn-warning" onclick="suspendUser()">Suspend User</button>
                            <% } %>
                            <button class="btn btn-danger" onclick="deleteUser()">Delete User</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Habits -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Habits (<%= habits.length %>)</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Duration (Days)</th>
                                <th>Current Streak</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% habits.forEach(habit => { %>
                                <tr>
                                    <td><%= habit.name %></td>
                                    <td><span class="badge bg-info"><%= habit.duration_days %> days</span></td>
                                    <td><%= habit.current_streak || 0 %> days</td>
                                    <td><%= new Date(habit.created_at).toLocaleDateString() %></td>
                                </tr>
                            <% }); %>
                            <% if (habits.length === 0) { %>
                                <tr><td colspan="4" class="text-center text-muted">No habits</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Challenges -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Challenges (<%= challenges.length %>)</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Started</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% challenges.forEach(challenge => { %>
                                <tr>
                                    <td><%= challenge.title %></td>
                                    <td><%= challenge.duration_days %> days</td>
                                    <td><span class="badge bg-<%= challenge.status === 'completed' ? 'success' : 'primary' %>"><%= challenge.status %></span></td>
                                    <td><%= new Date(challenge.start_date).toLocaleDateString() %></td>
                                </tr>
                            <% }); %>
                            <% if (challenges.length === 0) { %>
                                <tr><td colspan="4" class="text-center text-muted">No challenges</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Badges -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Badges (<%= badges.length %>)</h5>
                <div class="row">
                    <% badges.forEach(badge => { %>
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div style="font-size: 2rem;">üèÜ</div>
                                    <strong><%= badge.badge_name %></strong>
                                    <p class="text-muted small mb-0">Awarded on <%= new Date(badge.awarded_at).toLocaleDateString() %></p>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                    <% if (badges.length === 0) { %>
                        <div class="col-12 text-center text-muted">No badges earned yet</div>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script data-user-id="<%= user.id %>">
        const userId = parseInt(document.currentScript.dataset.userId);

        async function updateXP() {
            const xp = document.getElementById('xpInput').value;
            try {
                const response = await fetch(`/admin/users/${userId}/xp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ xp: parseInt(xp) })
                });
                const data = await response.json();
                if (data.success) {
                    alert('XP updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error updating XP');
            }
        }

        async function awardBadge() {
            const badgeName = document.getElementById('badgeInput').value;
            if (!badgeName) {
                alert('Please enter a badge name');
                return;
            }
            try {
                const response = await fetch(`/admin/users/${userId}/badge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ badgeName })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Badge awarded successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error awarding badge');
            }
        }

        async function suspendUser() {
            const reason = prompt('Enter suspension reason:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/admin/users/${userId}/suspend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                const data = await response.json();
                if (data.success) {
                    alert('User suspended successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error suspending user');
            }
        }

        async function unsuspendUser() {
            if (!confirm('Are you sure you want to unsuspend this user?')) return;
            
            try {
                const response = await fetch(`/admin/users/${userId}/unsuspend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    alert('User unsuspended successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error unsuspending user');
            }
        }

        async function deleteUser() {
            if (!confirm('Are you ABSOLUTELY sure you want to delete this user? This action cannot be undone!')) return;
            if (!confirm('This will permanently delete all user data including habits, challenges, and badges. Continue?')) return;
            
            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    alert('User deleted successfully!');
                    window.location.href = '/admin/users';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error deleting user');
            }
        }
    </script>
</body>
</html>
