<%- include('../partials/header') %>

<div class="modern-dashboard">
    <!-- Sidebar -->
    <div class="dashboard-sidebar">
        <!-- User Profile -->
        <div class="user-profile-card card-interactive">
            <div class="user-avatar">
                <div class="avatar-circle interactive-icon">
                    <span class="avatar-text"><%= currentUser.username.charAt(0).toUpperCase() %></span>
                </div>
                <div class="online-indicator"></div>
            </div>
            <div class="user-info">
                <h6 class="user-name"><%= currentUser.username %></h6>
                <p class="user-xp">
                    <span class="interactive-icon">üåü</span> 
                    <%= user.xp || 0 %> XP
                    <span class="xp-badge">Level <%= Math.floor((user.xp || 0) / 100) + 1 %></span>
                </p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-navigation">
            <a href="/dashboard" class="nav-link active">
                <span class="nav-icon interactive-icon">üè†</span>
                <span class="nav-label">Dashboard</span>
                <div class="nav-indicator"></div>
            </a>
            <a href="/challenges" class="nav-link">
                <span class="nav-icon interactive-icon">üèÜ</span>
                <span class="nav-label">Challenges</span>
                <span class="nav-badge">New</span>
            </a>
            <a href="/analytics" class="nav-link">
                <span class="nav-icon interactive-icon">üìä</span>
                <span class="nav-label">Analytics</span>
            </a>
            <a href="/habits/add" class="nav-link">
                <span class="nav-icon interactive-icon">‚ûï</span>
                <span class="nav-label">Add Habit</span>
            </a>
        </nav>

        <!-- Quick Stats -->
        <div class="sidebar-stats">
            <h6 class="stats-title">Today's Progress</h6>
            <div class="quick-stat">
               
                <div class="stat-info">
                    <span class="stat-value"><%= completedCount %>/<%= totalCount %></span>
                    <span class="stat-label">Completed</span>
                </div>
            </div>
            <div class="quick-stat">
            
                <div class="stat-info">
                    <span class="stat-value"><%= weeklyStats.active_days || 0 %></span>
                    <span class="stat-label">Active Days</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-main">
        <!-- Header Section -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">Good <%= new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 18 ? 'afternoon' : 'evening' %>, <%= currentUser.username %>! üëã</h1>
                <p class="dashboard-subtitle">Let's continue building great habits today</p>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshDashboard()" title="Refresh dashboard">
                    <span class="interactive-icon">üîÑ</span>
                </button>
                <button class="icon-btn" onclick="toggleNotifications()" title="Toggle notifications">
                    <span class="interactive-icon">üîî</span>
                </button>
                <button class="icon-btn" onclick="showQuickAdd()" title="Quick add habit">
                    <span class="interactive-icon">‚ö°</span>
                </button>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
            <div class="progress-card main-progress">
                <div class="progress-header">
                    <h3 class="progress-title">Today's Progress</h3>
                    <span class="progress-date"><%= new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) %></span>
                </div>
                <div class="progress-visual">
                    <div class="circular-progress" data-percent="<%= completionPercentage %>">
                        <svg class="progress-ring" width="120" height="120">
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle class="progress-ring-background" cx="60" cy="60" r="54" />
                            <circle class="progress-ring-fill" cx="60" cy="60" r="54" 
                                stroke-dasharray="339.292" 
                                stroke-dashoffset="<%= 339.292 - (339.292 * completionPercentage) / 100 %>" />
                        </svg>
                        <div class="progress-content">
                            <span class="progress-percentage"><%= completionPercentage %>%</span>
                            <span class="progress-label">Complete</span>
                        </div>
                    </div>
                </div>
                <div class="progress-stats">
                    <div class="stat-item">
                        <span class="stat-number"><%= completedCount %></span>
                        <span class="stat-text">Completed</span>
                    </div>
                    <div class="stat-divider">‚Ä¢</div>
                    <div class="stat-item">
                        <span class="stat-number"><%= totalCount %></span>
                        <span class="stat-text">Total</span>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-content">
                        <span class="stat-value"><%= weeklyStats.active_days || 0 %></span>
                        <span class="stat-label">Active Days</span>
                        <span class="stat-sublabel">This Week</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-content">
                        <span class="stat-value"><%= weeklyStats.total_completions || 0 %></span>
                        <span class="stat-label">Completions</span>
                        <span class="stat-sublabel">This Week</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåü</div>
                    <div class="stat-content">
                        <span class="stat-value"><%= user.xp || 0 %></span>
                        <span class="stat-label">XP Points</span>
                        <span class="stat-sublabel">Total Earned</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievement Showcase -->
        <% if (recentBadges && recentBadges.length > 0) { %>
        <div class="achievement-showcase" style="margin: 2rem 0;">
            <div class="section-header" style="margin-bottom: 1.5rem;">
                <h2 class="section-title">üèÜ Achievement Showcase</h2>
                <a href="/analytics" class="view-all-link" style="color: #10b981; text-decoration: none; font-size: 0.9rem;">
                    View All ‚Üí
                </a>
            </div>
            <div class="badges-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                <% recentBadges.forEach(badge => { %>
                <div class="badge-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;">
                    <div class="badge-icon" style="font-size: 3rem; margin-bottom: 0.5rem;">üèÜ</div>
                    <h4 style="font-size: 0.95rem; font-weight: 600; color: #065f46; margin: 0 0 0.25rem 0;"><%= badge.badge_name %></h4>
                    <p style="font-size: 0.75rem; color: #059669; margin: 0;">
                        <%= new Date(badge.earned_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
                    </p>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>

        <!-- Habits Section Header -->
        <div class="section-header">
            <h2 class="section-title">Your Habits</h2>
            <div class="header-right">
                <div class="view-toggle">
                    <button class="view-btn" id="gridViewBtn" onclick="switchView('grid')" title="Grid View">
                        <span>‚ñ¶</span>
                    </button>
                    <button class="view-btn" id="listViewBtn" onclick="switchView('list')" title="List View">
                        <span>‚ò∞</span>
                    </button>
                </div>
                <a href="/habits/add" class="add-habit-btn">
                    Add New Habit
                </a>
            </div>
        </div>

        <!-- Modern Habits Grid -->
        <div class="habits-container">
            <% if ((habits && habits.length > 0) || (activeChallenges && activeChallenges.length > 0)) { %>
                <div class="habits-grid">
                    <% habits.forEach((habit, index) => { %>
                        <div class="habit-card <%= habit.is_completed ? 'completed' : '' %>" data-habit-id="<%= habit.id %>">
                            <div class="habit-header">
                                <div class="habit-icon">
                                    <span class="habit-emoji">
                                        <% if (habit.name.toLowerCase().includes('workout') || habit.name.toLowerCase().includes('exercise') || habit.name.toLowerCase().includes('gym')) { %>
                                            üí™
                                        <% } else if (habit.name.toLowerCase().includes('read')) { %>
                                            üìö
                                        <% } else if (habit.name.toLowerCase().includes('water') || habit.name.toLowerCase().includes('drink')) { %>
                                            üíß
                                        <% } else if (habit.name.toLowerCase().includes('run')) { %>
                                            üèÉ
                                        <% } else if (habit.name.toLowerCase().includes('meditat')) { %>
                                            üßò
                                        <% } else if (habit.name.toLowerCase().includes('study') || habit.name.toLowerCase().includes('learn')) { %>
                                            üìñ
                                        <% } else if (habit.name.toLowerCase().includes('sleep')) { %>
                                            üò¥
                                        <% } else if (habit.name.toLowerCase().includes('walk')) { %>
                                            üö∂
                                        <% } else { %>
                                            ‚ú®
                                        <% } %>
                                    </span>
                                </div>
                                <button class="habit-toggle-btn" onclick="toggleHabit('<%= habit.id %>', this)">
                                    <span class="toggle-icon">
                                        <% if (habit.is_completed) { %>
                                            ‚úì
                                        <% } else { %>
                                            <span class="empty-circle"></span>
                                        <% } %>
                                    </span>
                                </button>
                            </div>
                            <div class="habit-content">
                                <h3 class="habit-title"><%= habit.name %></h3>
                                <p class="habit-category"><%= habit.category || 'General' %></p>
                                <div class="habit-streak">
                                    <span class="streak-icon">üî•</span>
                                    <span class="streak-text"><%= habit.streak || 0 %> day streak</span>
                                </div>
                                <% if (habit.duration_days && habit.days_remaining !== undefined) { %>
                                <div class="habit-progress-info">
                                    <span class="progress-days"><%= habit.progress %>/<%= habit.duration_days %> days</span>
                                    <% if (habit.days_remaining > 0) { %>
                                        <span class="days-left">‚Ä¢ <%= habit.days_remaining %> days left</span>
                                    <% } else { %>
                                        <span class="days-left final">‚Ä¢ Final day!</span>
                                    <% } %>
                                </div>
                                <% } %>
                            </div>
                            <div class="habit-actions">
                                <button class="action-btn-small" onclick="editHabit('<%= habit.id %>')" title="Edit Habit">
                                    ‚úèÔ∏è
                                </button>
                                <button class="action-btn-small delete-btn" onclick="deleteHabit('<%= habit.id %>')" title="Delete Habit">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    <% }) %>
                    
                    <% activeChallenges.forEach((challenge, index) => { %>
                        <div class="habit-card challenge-card <%= challenge.is_completed ? 'completed' : '' %>" data-challenge-id="<%= challenge.id %>">
                            <div class="habit-header">
                                <div class="habit-icon challenge-icon">
                                    <span class="habit-emoji">üèÜ</span>
                                    <span class="challenge-badge">Challenge</span>
                                </div>
                                <button class="habit-toggle-btn" onclick="toggleChallenge('<%= challenge.id %>', this)">
                                    <span class="toggle-icon">
                                        <% if (challenge.is_completed) { %>
                                            ‚úì
                                        <% } else { %>
                                            <span class="empty-circle"></span>
                                        <% } %>
                                    </span>
                                </button>
                            </div>
                            <div class="habit-content">
                                <h3 class="habit-title"><%= challenge.name %></h3>
                                <p class="habit-category"><%= challenge.category || 'Challenge' %></p>
                                <div class="habit-streak">
                                    <span class="streak-icon">üî•</span>
                                    <span class="streak-text"><%= challenge.streak || 0 %> day streak</span>
                                </div>
                            </div>
                            <div class="habit-actions">
                                <button class="action-btn-small" onclick="viewChallenge()" title="View Challenge">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </div>
                    <% }) %>
                    
                    <!-- Add New Habit Card -->
                    <div class="habit-card add-new-card">
                        <a href="/habits/add" class="add-new-link">
                            <div class="add-new-content">
                                <div class="add-icon">‚ûï</div>
                                <h3 class="add-title">Add New Habit</h3>
                                <p class="add-subtitle">Start building a new routine</p>
                            </div>
                        </a>
                    </div>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <div class="empty-icon">üå±</div>
                    <h3 class="empty-title">No Habits Yet</h3>
                    <p class="empty-description">Start your journey by creating your first habit. Small steps lead to big changes!</p>
                    <a href="/habits/add" class="create-first-habit-btn">
                        <span class="btn-icon">üöÄ</span>
                        Create Your First Habit
                    </a>
                </div>
            <% } %>
        </div>

        <!-- Completed Habits Section -->
        <% if (completedHabits && completedHabits.length > 0) { %>
        <div class="section-header" style="margin-top: 3rem;">
            <h2 class="section-title">‚úÖ Completed Habits</h2>
        </div>
        <div class="habits-container">
            <div class="habits-grid">
                <% completedHabits.forEach((habit) => { %>
                    <div class="habit-card completed-habit" data-habit-id="<%= habit.id %>">
                        <div class="habit-header">
                            <div class="habit-icon">
                                <span class="habit-emoji">üéâ</span>
                            </div>
                            <span class="status-badge completed-badge">Completed!</span>
                        </div>
                        <div class="habit-content">
                            <h3 class="habit-title"><%= habit.name %></h3>
                            <p class="habit-category"><%= habit.category || 'General' %></p>
                            <div class="habit-streak">
                                <span class="streak-icon">üèÜ</span>
                                <span class="streak-text"><%= habit.streak || habit.duration_days %> day streak achieved</span>
                            </div>
                            <p class="completion-date">Completed <%= new Date(habit.completed_at).toLocaleDateString() %></p>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
        <% } %>

        <!-- Failed Habits Section -->
        <% if (failedHabits && failedHabits.length > 0) { %>
        <div class="section-header" style="margin-top: 3rem;">
            <h2 class="section-title">‚ö†Ô∏è Not Finished / Ended Habits</h2>
        </div>
        <div class="habits-container">
            <div class="habits-grid">
                <% failedHabits.forEach((habit) => { %>
                    <div class="habit-card failed-habit" data-habit-id="<%= habit.id %>">
                        <div class="habit-header">
                            <div class="habit-icon">
                                <span class="habit-emoji">üíî</span>
                            </div>
                            <span class="status-badge failed-badge">Not Finished</span>
                        </div>
                        <div class="habit-content">
                            <h3 class="habit-title"><%= habit.name %></h3>
                            <p class="habit-category"><%= habit.category || 'General' %></p>
                            <div class="habit-streak">
                                <span class="streak-icon">üìä</span>
                                <span class="streak-text">Goal: <%= habit.duration_days %> days</span>
                            </div>
                            <p class="completion-date">Ended <%= new Date(habit.end_date).toLocaleDateString() %></p>
                        </div>
                        <div class="habit-actions">
                            <button class="action-btn-small delete-btn" onclick="deleteHabit('<%= habit.id %>')" title="Delete Habit">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
        <% } %>

        <!-- Completed Challenges Section -->
        <% if (completedChallenges && completedChallenges.length > 0) { %>
        <div class="section-header" style="margin-top: 3rem;">
            <h2 class="section-title">üèÖ Completed Challenges</h2>
        </div>
        <div class="habits-container">
            <div class="habits-grid">
                <% completedChallenges.forEach((challenge) => { %>
                    <div class="habit-card challenge-card completed-habit" data-challenge-id="<%= challenge.id %>">
                        <div class="habit-header">
                            <div class="habit-icon challenge-icon">
                                <span class="habit-emoji">üèÜ</span>
                            </div>
                            <span class="status-badge completed-badge">Challenge Done!</span>
                        </div>
                        <div class="habit-content">
                            <h3 class="habit-title"><%= challenge.name %></h3>
                            <p class="habit-category">+<%= challenge.xp_reward %> XP Earned</p>
                            <div class="habit-streak">
                                <span class="streak-icon">üî•</span>
                                <span class="streak-text"><%= challenge.duration_days %> day challenge completed</span>
                            </div>
                            <p class="completion-date">Completed <%= new Date(challenge.completed_at).toLocaleDateString() %></p>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
        <% } %>

        <!-- Failed Challenges Section -->
        <% if (failedChallenges && failedChallenges.length > 0) { %>
        <div class="section-header" style="margin-top: 3rem;">
            <h2 class="section-title">‚ùå Not Finished / Ended Challenges</h2>
        </div>
        <div class="habits-container">
            <div class="habits-grid">
                <% failedChallenges.forEach((challenge) => { %>
                    <div class="habit-card challenge-card failed-habit" data-challenge-id="<%= challenge.id %>">
                        <div class="habit-header">
                            <div class="habit-icon challenge-icon">
                                <span class="habit-emoji">‚õî</span>
                            </div>
                            <span class="status-badge failed-badge">Challenge Ended</span>
                        </div>
                        <div class="habit-content">
                            <h3 class="habit-title"><%= challenge.name %></h3>
                            <p class="habit-category">Goal: <%= challenge.duration_days %> days</p>
                            <div class="habit-streak">
                                <span class="streak-icon">üìâ</span>
                                <span class="streak-text">Streak not maintained</span>
                            </div>
                            <p class="completion-date">Ended <%= new Date(challenge.failed_at).toLocaleDateString() %></p>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
        <% } %>
    </div>
</div>

<!-- JavaScript for Interactive Features -->
<script>
// ============================================
// WEBSOCKET INITIALIZATION
// ============================================
const socket = io();
const currentUserId = '<%= currentUser.id %>';

// Join user-specific room
socket.emit('join_user_room', currentUserId);

// Listen for real-time habit updates
socket.on('habit_update', function(data) {
    console.log('Real-time habit update received:', data);
    
    // If habit was created, updated, or deleted, reload page to show changes
    if (data.action === 'created' || data.action === 'updated' || data.action === 'deleted') {
        console.log('Habit structure changed, reloading...');
        window.location.reload();
        return;
    }
    
    // Otherwise, just update the existing card
    updateHabitCardRealtime(data);
    
    // Always update XP display after habit completion
    updateXPDisplay(data.xpEarned || 0, data.isCompleted);
    
    // Update Today's Progress counter in real-time
    updateTodaysProgress(data.isCompleted);
});

// Listen for real-time challenge updates
socket.on('challenge_update', function(data) {
    console.log('Real-time challenge update received:', data);
    updateChallengeCardRealtime(data);
});

// ============================================
// STORAGE FEATURES INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // 1. Show welcome message for new users (only once)
    const hasSeenWelcome = localStorage.getItem('hasSeenWelcome_<%= user.id %>');
    const urlParams = new URLSearchParams(window.location.search);
    const isWelcome = urlParams.get('welcome');
    
    // Show welcome message only if user hasn't seen it and coming from signup
    if (isWelcome === 'true' && !hasSeenWelcome) {
        showWelcomeMessage();
        localStorage.setItem('hasSeenWelcome_<%= user.id %>', 'true');
        console.log('Welcome message shown (new user)');
        // Remove welcome parameter from URL without refresh
        window.history.replaceState({}, document.title, '/dashboard');
    }
    
    // Restore saved view preference (grid or list)
    const savedView = Preferences.dashboardView.get();
    switchView(savedView);
});

// Show welcome message modal
function showWelcomeMessage() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s ease;';
    
    modal.innerHTML = `
        <div style="background:white;padding:2.5rem;border-radius:16px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideUp 0.4s ease;">
            <div style="text-align:center;">
                <div style="font-size:3rem;margin-bottom:1rem;">üéâ</div>
                <h2 style="font-size:1.75rem;font-weight:700;color:#111827;margin-bottom:1rem;">Welcome to DailyEdge!</h2>
                <p style="font-size:1rem;color:#6B7280;margin-bottom:1.5rem;">
                    Start building better habits today. Track your progress, earn XP, and achieve your goals one day at a time!
                </p>
                <div style="background:#F3F4F6;padding:1rem;border-radius:8px;margin-bottom:1.5rem;text-align:left;">
                    <p style="font-size:0.875rem;color:#374151;margin:0.5rem 0;"><strong>‚úì</strong> Create custom habits</p>
                    <p style="font-size:0.875rem;color:#374151;margin:0.5rem 0;"><strong>‚úì</strong> Join challenges</p>
                    <p style="font-size:0.875rem;color:#374151;margin:0.5rem 0;"><strong>‚úì</strong> Track your analytics</p>
                    <p style="font-size:0.875rem;color:#374151;margin:0.5rem 0;"><strong>‚úì</strong> Earn badges and XP</p>
                </div>
                <button onclick="closeWelcomeMessage()" style="background:#10B981;color:white;border:none;padding:0.75rem 2rem;border-radius:8px;font-weight:600;font-size:1rem;cursor:pointer;width:100%;transition:background 0.2s;">
                    Get Started
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    window.closeWelcomeMessage = function() {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => modal.remove(), 300);
    };
}

// ============================================
// VIEW TOGGLE FUNCTION (Grid/List)
// ============================================
function switchView(view) {
    const habitsGrid = document.querySelector('.habits-grid');
    const gridBtn = document.getElementById('gridViewBtn');
    const listBtn = document.getElementById('listViewBtn');
    
    if (!habitsGrid || !gridBtn || !listBtn) return;
    
    // Update view
    if (view === 'list') {
        habitsGrid.classList.add('list-view');
        habitsGrid.classList.remove('grid-view');
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
    } else {
        habitsGrid.classList.add('grid-view');
        habitsGrid.classList.remove('list-view');
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
    }
    
    // Save preference to localStorage
    Preferences.dashboardView.set(view);
}

// ============================================
// HABIT TOGGLE FUNCTION
// ============================================
async function toggleHabit(habitId, button) {
    try {
        // Show celebration loader for completion
        showCelebrationLoader();
        
        // Add loading state
        const toggleIcon = button.querySelector('.toggle-icon');
        const originalContent = toggleIcon.innerHTML;
        toggleIcon.innerHTML = '<span class="loading-spinner">‚è≥</span>';
        button.disabled = true;

        const response = await fetch(`/habits/toggle/${habitId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        const data = await response.json();

        if (data.success) {
            const habitCard = button.closest('.habit-card');
            const isCompleted = data.completed;
            
            // Update the card visual state
            if (isCompleted) {
                habitCard.classList.add('completed');
                toggleIcon.innerHTML = '‚úì';
                
                // Show completion celebration
                setTimeout(() => {
                    hideCelebrationLoader();
                    showCompletionCelebration();
                }, 800);
            } else {
                habitCard.classList.remove('completed');
                toggleIcon.innerHTML = '<span class="empty-circle"></span>';
                hideCelebrationLoader();
            }
            
            // Update progress display
            updateProgressDisplay();
            
            // Always update XP display after habit toggle
            console.log('Updating XP display, earned:', data.xpEarned);
            updateXPDisplay(data.xpEarned || 0, isCompleted);
            
            // Emit real-time update via WebSocket
            socket.emit('habit_completed', {
                userId: currentUserId,
                habitId: habitId,
                isCompleted: isCompleted,
                streak: data.streak || 0,
                xpEarned: data.xpEarned || 0
            });
            
            // Show success feedback with encouraging message
            if (isCompleted) {
                const encouragingMessages = [
                    "Yippee! Done for today! üéâ Great work, champ!",
                    "Amazing! You're on fire! üî• Keep it up!",
                    "Fantastic! Another goal crushed! üí™",
                    "Wonderful! You're building amazing habits! ‚≠ê",
                    "Excellent! Progress feels great, doesn't it? üåü"
                ];
                const randomMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                showNotification(randomMessage, 'success');
            } else {
                showNotification('Habit unmarked', 'info');
            }
        } else {
            hideCelebrationLoader();
            throw new Error(data.error || 'Failed to update habit');
        }
    } catch (error) {
        console.error('Error toggling habit:', error);
        showNotification('Failed to update habit. Please try again.', 'error');
        // Reset button state
        toggleIcon.innerHTML = originalContent;
    } finally {
        button.disabled = false;
    }
}

async function toggleChallenge(challengeId, button) {
    try {
        // Show celebration loader for completion
        showCelebrationLoader();
        
        // Add loading state
        const toggleIcon = button.querySelector('.toggle-icon');
        const originalContent = toggleIcon.innerHTML;
        toggleIcon.innerHTML = '<span class="loading-spinner">‚è≥</span>';
        button.disabled = true;

        const response = await fetch(`/challenges/toggle/${challengeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        const data = await response.json();

        if (data.success) {
            const challengeCard = button.closest('.habit-card');
            const isCompleted = data.completed;
            
            // Update the card visual state
            if (isCompleted) {
                challengeCard.classList.add('completed');
                toggleIcon.innerHTML = '‚úì';
                
                // Show completion celebration
                setTimeout(() => {
                    hideCelebrationLoader();
                    showCompletionCelebration();
                }, 800);
            } else {
                challengeCard.classList.remove('completed');
                toggleIcon.innerHTML = '<span class="empty-circle"></span>';
                hideCelebrationLoader();
            }
            
            // Update progress display
            updateProgressDisplay();
            
            // Emit real-time update via WebSocket
            socket.emit('challenge_completed', {
                userId: currentUserId,
                challengeId: challengeId,
                isCompleted: isCompleted,
                streak: data.streak || 0
            });
            
            // Show success feedback with encouraging message
            if (isCompleted) {
                const encouragingMessages = [
                    "Challenge progress! Keep pushing! üèÜ",
                    "You're crushing this challenge! üí™",
                    "Amazing dedication! Keep going! üåü",
                    "Challenge beast mode! üî•",
                    "One day closer to victory! ‚≠ê"
                ];
                const randomMessage = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                showNotification(randomMessage, 'success');
            } else {
                showNotification('Challenge unmarked', 'info');
            }
        } else {
            hideCelebrationLoader();
            throw new Error(data.error || 'Failed to update challenge');
        }
    } catch (error) {
        console.error('Error toggling challenge:', error);
        showNotification('Failed to update challenge. Please try again.', 'error');
        // Reset button state
        toggleIcon.innerHTML = originalContent;
    } finally {
        button.disabled = false;
    }
}

async function updateProgressDisplay() {
    try {
        console.log('Updating progress display...');
        // Fetch fresh stats from server
        const response = await fetch('/dashboard/stats');
        const stats = await response.json();
        console.log('Stats received:', stats);
        
        // Update circular progress
        const progressRing = document.querySelector('.progress-ring-fill');
        const progressPercentage = document.querySelector('.progress-percentage');
        const progressStats = document.querySelectorAll('.stat-number');
        
        if (progressRing) {
            const circumference = 339.292;
            const offset = circumference - (circumference * stats.completionPercentage) / 100;
            progressRing.style.strokeDashoffset = offset;
            console.log('Updated progress ring to', stats.completionPercentage + '%');
        }
        
        if (progressPercentage) {
            progressPercentage.textContent = stats.completionPercentage + '%';
        }
        
        // Update stats in circular progress
        if (progressStats.length >= 2) {
            progressStats[0].textContent = stats.completedCount;
            progressStats[1].textContent = stats.totalCount;
            console.log('Updated stats:', stats.completedCount, '/', stats.totalCount);
        }
        
        // Update stat cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            const label = card.querySelector('.stat-label')?.textContent;
            const valueElement = card.querySelector('.stat-value');
            
            if (label === 'Active Days' && valueElement) {
                valueElement.textContent = stats.activeDays;
            } else if (label === 'Completions' && valueElement) {
                valueElement.textContent = stats.totalCompletions;
            } else if (label === 'XP Points' && valueElement) {
                valueElement.textContent = stats.xp;
            }
        });
        
        // Update XP in sidebar
        const userXP = document.querySelector('.user-xp');
        if (userXP && stats.xp !== undefined) {
            const level = Math.floor(stats.xp / 100) + 1;
            userXP.innerHTML = `<span class="interactive-icon">üåü</span> ${stats.xp} XP <span class="xp-badge">Level ${level}</span>`;
        }
        
        console.log('Progress display updated successfully');
    } catch (error) {
        console.error('Error updating progress display:', error);
    }
}

function editHabit(habitId) {
    window.location.href = `/habits/edit/${habitId}`;
}

async function deleteHabit(habitId) {
    if (!confirm('Are you sure you want to delete this habit? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/habits/delete/${habitId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        
        if (response.ok) {
            // Remove the card from the DOM
            const habitCard = document.querySelector(`[data-habit-id="${habitId}"]`);
            if (habitCard) {
                habitCard.style.opacity = '0';
                habitCard.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    habitCard.remove();
                    updateProgressDisplay();
                }, 300);
            }
            showNotification('Habit deleted successfully', 'success');
        } else {
            throw new Error('Failed to delete habit');
        }
    } catch (error) {
        console.error('Error deleting habit:', error);
        showNotification('Failed to delete habit. Please try again.', 'error');
    }
}

function viewChallenge() {
    window.location.href = '/challenges';
}

// ============================================
// REAL-TIME UPDATE HANDLERS
// ============================================
// Real-time XP update function
function updateXPDisplay(xpEarned, isCompleted) {
    // Show XP gain notification
    if (isCompleted && xpEarned) {
        showNotification(`+${xpEarned} XP earned!`, 'success');
    }
}

function updateHabitCardRealtime(data) {
    const habitCard = document.querySelector(`[data-habit-id="${data.habitId}"]`);
    if (!habitCard) return;
    
    const toggleBtn = habitCard.querySelector('.habit-toggle-btn');
    const toggleIcon = toggleBtn.querySelector('.toggle-icon');
    const streakText = habitCard.querySelector('.streak-text');
    
    if (data.isCompleted) {
        habitCard.classList.add('completed');
        toggleIcon.innerHTML = '‚úì';
    } else {
        habitCard.classList.remove('completed');
        toggleIcon.innerHTML = '<span class="empty-circle"></span>';
    }
    
    // Update streak if available
    if (streakText && data.streak !== undefined) {
        streakText.textContent = `${data.streak} day streak`;
    }
    
    // Update progress display
    updateProgressDisplay();
    
    console.log('Habit card updated in real-time');
}

function updateChallengeCardRealtime(data) {
    const challengeCard = document.querySelector(`[data-challenge-id="${data.challengeId}"]`);
    if (!challengeCard) return;
    
    const toggleBtn = challengeCard.querySelector('.habit-toggle-btn');
    const toggleIcon = toggleBtn.querySelector('.toggle-icon');
    const streakText = challengeCard.querySelector('.streak-text');
    
    if (data.isCompleted) {
        challengeCard.classList.add('completed');
        toggleIcon.innerHTML = '‚úì';
    } else {
        challengeCard.classList.remove('completed');
        toggleIcon.innerHTML = '<span class="empty-circle"></span>';
    }
    
    // Update streak if available
    if (streakText && data.streak !== undefined) {
        streakText.textContent = `${data.streak} day streak`;
    }
    
    // Update progress display
    updateProgressDisplay();
    
    console.log('Challenge card updated in real-time');
}

function updateTodaysProgress(isCompleted) {
    const statValueElement = document.querySelector('.sidebar-stats .stat-value');
    if (!statValueElement) return;
    
    // Parse current values (e.g., "1/1" -> [1, 1])
    const [completed, total] = statValueElement.textContent.split('/').map(Number);
    
    // Update completed count based on completion status
    let newCompleted = isCompleted ? completed + 1 : Math.max(0, completed - 1);
    
    // Update display
    statValueElement.textContent = `${newCompleted}/${total}`;
    
    console.log(`Today's Progress updated: ${newCompleted}/${total}`);
}

function refreshDashboard() {
    window.location.reload();
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => notification.classList.add('show'), 100);
    
    // Remove after delay
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Enhanced Interactive Functions
function refreshDashboard() {
    const refreshBtn = event.target.closest('.icon-btn');
    
    // Simple scale feedback
    refreshBtn.style.transform = 'scale(0.9)';
    setTimeout(() => {
        refreshBtn.style.transform = 'scale(1)';
    }, 150);
    
    // Show feedback and refresh
    showNotification('Dashboard refreshed!', 'success');
    
    // Simulate refresh (in real app, this would reload data)
    setTimeout(() => {
        location.reload();
    }, 800);
}

function toggleNotifications() {
    const btn = event.target.closest('.icon-btn');
    btn.classList.toggle('active');
    
    const isActive = btn.classList.contains('active');
    showNotification(
        isActive ? 'Notifications enabled' : 'Notifications disabled', 
        'info'
    );
}

function showQuickAdd() {
    const overlay = document.createElement('div');
    overlay.className = 'quick-add-overlay';
    overlay.innerHTML = `
        <div class="quick-add-modal">
            <h3>Quick Add Habit</h3>
            <input type="text" placeholder="Enter habit name..." class="quick-add-input">
            <div class="quick-add-actions">
                <button class="btn btn-primary" onclick="addQuickHabit()">Add</button>
                <button class="btn btn-secondary" onclick="closeQuickAdd()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    setTimeout(() => overlay.classList.add('show'), 10);
}

function addQuickHabit() {
    const input = document.querySelector('.quick-add-input');
    if (input.value.trim()) {
        showNotification('Habit added successfully!', 'success');
        closeQuickAdd();
        // Here you would normally send the data to the server
    }
}

function closeQuickAdd() {
    const overlay = document.querySelector('.quick-add-overlay');
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => overlay.remove(), 300);
    }
}

// Celebration Loader Functions
function showCelebrationLoader() {
    const loader = document.createElement('div');
    loader.className = 'celebration-loader';
    loader.id = 'celebration-loader';
    loader.innerHTML = `
        <div class="celebration-content">
            <div class="celebration-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-icon">üéâ</div>
            </div>
            <div class="celebration-text">Processing your awesome progress...</div>
        </div>
    `;
    
    document.body.appendChild(loader);
    setTimeout(() => loader.classList.add('show'), 10);
}

function hideCelebrationLoader() {
    const loader = document.getElementById('celebration-loader');
    if (loader) {
        loader.classList.remove('show');
        setTimeout(() => loader.remove(), 300);
    }
}

function showCompletionCelebration() {
    const celebration = document.createElement('div');
    celebration.className = 'completion-celebration';
    celebration.innerHTML = `
        <div class="celebration-burst">
            <div class="burst-particle">üéâ</div>
            <div class="burst-particle">‚≠ê</div>
            <div class="burst-particle">üéä</div>
            <div class="burst-particle">‚ú®</div>
            <div class="burst-particle">üåü</div>
            <div class="burst-particle">üéà</div>
        </div>
    `;
    
    document.body.appendChild(celebration);
    
    // Remove after animation
    setTimeout(() => {
        celebration.remove();
    }, 2000);
}

// Initialize progress animation on page load
document.addEventListener('DOMContentLoaded', function() {
    updateProgressDisplay();
    
    // Add interaction effects to habit cards
    const habitCards = document.querySelectorAll('.habit-item');
    habitCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>

<!-- Floating Action Button -->
<button class="fab" onclick="showQuickAdd()" title="Quick add habit">
    <span class="interactive-icon">‚ûï</span>
</button>

<!-- Quick Add Modal Styles -->
<style>
.badge-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.15) !important;
}

.view-all-link:hover {
    color: #059669 !important;
    text-decoration: underline !important;
}

.achievement-showcase {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.quick-add-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.quick-add-overlay.show {
    opacity: 1;
}

.quick-add-modal {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    border: 1px solid var(--card-border);
    box-shadow: var(--card-shadow);
    min-width: 300px;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.quick-add-overlay.show .quick-add-modal {
    transform: scale(1);
}

.quick-add-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-primary);
    margin: 1rem 0;
}

.quick-add-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

.online-indicator {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    background: var(--success-color);
    border-radius: 50%;
    border: 2px solid var(--card-bg);
    animation: pulse 2s infinite;
}

.xp-badge {
    background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: 0.5rem;
}

.nav-indicator {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 20px;
    background: var(--primary-color);
    border-radius: 2px;
}

.nav-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--error-color);
    color: white;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
    font-size: 0.6rem;
    font-weight: 600;
}

.icon-btn.active {
    background: var(--primary-color) !important;
    color: white !important;
}

/* Celebration Loader Styles */
.celebration-loader {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.celebration-loader.show {
    opacity: 1;
}

.celebration-content {
    text-align: center;
    color: white;
}

.celebration-spinner {
    position: relative;
    width: 80px;
    height: 80px;
    margin: 0 auto 1rem;
}

.spinner-ring {
    position: absolute;
    width: 80px;
    height: 80px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top: 4px solid #6366f1;
    border-radius: 50%;
    animation: celebrationSpin 1s linear infinite;
}

.spinner-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    animation: bounce 0.6s ease-in-out infinite alternate;
}

.celebration-text {
    font-size: 1.1rem;
    font-weight: 500;
    color: #cbd5e0;
}

/* Completion Celebration */
.completion-celebration {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 2500;
}

.celebration-burst {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.burst-particle {
    position: absolute;
    font-size: 2rem;
    animation: burstAnimation 2s ease-out forwards;
}

.burst-particle:nth-child(1) { --delay: 0s; --angle: 0deg; }
.burst-particle:nth-child(2) { --delay: 0.1s; --angle: 60deg; }
.burst-particle:nth-child(3) { --delay: 0.2s; --angle: 120deg; }
.burst-particle:nth-child(4) { --delay: 0.3s; --angle: 180deg; }
.burst-particle:nth-child(5) { --delay: 0.4s; --angle: 240deg; }
.burst-particle:nth-child(6) { --delay: 0.5s; --angle: 300deg; }

@keyframes celebrationSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes bounce {
    0% { transform: translate(-50%, -50%) scale(1); }
    100% { transform: translate(-50%, -50%) scale(1.2); }
}

@keyframes burstAnimation {
    0% {
        transform: rotate(var(--angle)) translateX(0) scale(0);
        opacity: 1;
    }
    50% {
        transform: rotate(var(--angle)) translateX(150px) scale(1);
        opacity: 1;
    }
    100% {
        transform: rotate(var(--angle)) translateX(200px) scale(0);
        opacity: 0;
    }
}
</style>

<%- include('../partials/footer') %>